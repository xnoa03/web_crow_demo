<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•´ë¦¬ì•¼ í• ë˜ë§ë˜? </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #464646; color: #e0e0e0; font-family: 'Noto Sans KR', sans-serif; }
        .card { background-color: #ff9b9b; border: 1px solid #333; }
        .table { color: #e0e0e0; }
        .table-hover tbody tr:hover { color: #fff; background-color: #2c2c2c; }
        a { color: #bb86fc; text-decoration: none; }
        .btn-primary { background-color: #bb86fc; border: none; color: #000; font-weight: bold; }
        .btn-primary:hover { background-color: #9965f4; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .progress-container { width: 80%; max-width: 600px; }
        .badge-halgame { background-color: #ff1616; color: white; } /* í• ê²Œì„ ì „ìš© ìƒ‰ìƒ */
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <h3 class="mb-3 text-white">ğŸ¦¦ í•´ì¿ ì•„ë¦¬ì›€ íƒìƒ‰ ì¤‘...</h3>
        <div class="progress-container">
            <div class="progress" role="progressbar" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark" style="width: 0%">0%</div>
            </div>
            <p id="progressText" class="mt-2 text-center text-light">ì¤€ë¹„ ì¤‘...</p>
        </div>
    </div>

    <div class="container py-5">
        <div class="text-center mb-5">
            <h1>ğŸ¦¦ í•´ë¦¬ì•¼ í• ë˜ë§ë˜?</h1>
            
        </div>

        <div class="card mb-4 p-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">íƒìƒ‰í•  í˜ì´ì§€ ìˆ˜</label>
                    <input type="number" id="pageLimit" class="form-control bg-dark text-white border-secondary" value="3" min="1" max="10">
                </div>
                <div class="col-md-2">
                    <button onclick="startCrawlStream()" class="btn btn-primary w-100">ğŸš€ ë°ì´í„° ê°±ì‹ </button>
                </div>
                <div class="col-md-7 text-end">
                    <button onclick="randomPick()" class="btn btn-outline-warning">ğŸš ë§ˆë²•ì˜ ì†Œë¼ê³ ë™</button>
                </div>
            </div>
            <hr class="border-secondary my-4">
            
            <div class="row g-3">
                <div class="col-md-7">
                    <label class="form-label">ì¥ë¥´ í•„í„°</label>
                    <div id="tagFilters">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" value="ê²Œì„" checked onchange="applyFilters()">
                            <label class="form-check-label">ê²Œì„</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" value="ê³µê²œ" checked onchange="applyFilters()">
                            <label class="form-check-label">ê³µê²œ</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" value="í•  ê²Œì„" checked onchange="applyFilters()">
                            <label class="form-check-label fw-bold">í•  ê²Œì„</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" value="ê¸°íƒ€" checked onchange="applyFilters()">
                            <label class="form-check-label">ê¸°íƒ€</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">í”Œë ˆì´íƒ€ì„ (ìµœëŒ€ <span id="timeVal">100</span>ì‹œê°„)</label>
                    <input type="range" class="form-range" id="timeRange" min="0" max="100" value="100" oninput="document.getElementById('timeVal').innerText=this.value; applyFilters()">
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr class="table-dark">
                        <th>íƒœê·¸</th>
                        <th>ì œëª©</th>
                        <th>ê²Œì„ëª…</th>
                        <th>ê°€ê²©</th>
                        <th>í•œê¸€</th>
                        <th>í”Œíƒ€</th>
                        <th>ë§í¬</th>
                    </tr>
                </thead>
                <tbody id="gameTable">
                    {% for game in games %}
                    <tr class="game-row" data-tag="{{ game.ì¹´í…Œê³ ë¦¬ }}" data-time="{{ game.time_num }}">
                        <td>
                            {% if 'í• ' in game.ì¹´í…Œê³ ë¦¬ %}
                                <span class="badge badge-halgame">{{ game.ì¹´í…Œê³ ë¦¬ }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ game.ì¹´í…Œê³ ë¦¬ }}</span>
                            {% endif %}
                        </td>
                        <td><a href="{{ game.ê²Œì‹œê¸€ë§í¬ }}" target="_blank">{{ game.ê¸€ì œëª© }}</a></td>
                        <td class="fw-bold">{{ game.ê²Œì„ì´ë¦„ }}</td>
                        <td>{{ game.ê°€ê²© }}</td>
                        <td>{{ game.í•œê¸€í™” }}</td>
                        <td>{{ game.í”Œë ˆì´íƒ€ì„ }}</td>
                        <td>
                            {% if game.ë§í¬ != '-' %}
                            <a href="{{ game.ë§í¬ }}" target="_blank" class="btn btn-sm btn-outline-info">êµ¬ë§¤</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="conchModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">ğŸš ì†Œë¼ê³ ë™ì˜ ì„ íƒ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h2 class="text-warning mb-3" id="modalTitle">ê²Œì„ì´ë¦„</h2>
                    <p id="modalInfo">ì •ë³´</p>
                    <div id="modalLinks" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function applyFilters() {
            const timeLimit = parseFloat(document.getElementById('timeRange').value);
            // ë„ì–´ì“°ê¸° ë¬¸ì œ í•´ê²°: 'í•  ê²Œì„'ê³¼ 'í• ê²Œì„' ëª¨ë‘ í˜¸í™˜ë˜ë„ë¡ ì²˜ë¦¬
            const checkedTags = Array.from(document.querySelectorAll('#tagFilters input:checked')).map(cb => cb.value.replace(" ", ""));
            
            document.querySelectorAll('.game-row').forEach(row => {
                let tag = row.getAttribute('data-tag').replace(" ", ""); // ë°ì´í„° íƒœê·¸ë„ ê³µë°± ì œê±°í•˜ê³  ë¹„êµ
                const time = parseFloat(row.getAttribute('data-time'));
                
                // [í• ê²Œì„] íƒœê·¸ íŠ¹ìˆ˜ ì²˜ë¦¬ (í• ê²Œì„, í•  ê²Œì„ ëª¨ë‘ í—ˆìš©)
                if (tag === 'í• ê²Œì„') tag = 'í• ê²Œì„';
                
                if (checkedTags.includes(tag) && time <= timeLimit) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function startCrawlStream() {
            const pages = document.getElementById('pageLimit').value;
            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            loading.style.display = 'flex';
            progressBar.style.width = '0%';
            progressBar.innerText = '0%';
            progressText.innerText = 'ì„œë²„ ì—°ê²° ì¤‘...';

            const eventSource = new EventSource(`/crawl_stream?pages=${pages}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                const percent = data.progress + '%';
                progressBar.style.width = percent;
                progressBar.innerText = percent;
                progressText.innerText = data.msg;

                if (data.done) {
                    eventSource.close();
                    setTimeout(() => { location.reload(); }, 1000);
                }
            };

            eventSource.onerror = function() {
                eventSource.close();
                alert('ì—°ê²° ëŠê¹€');
                loading.style.display = 'none';
            };
        }

        function randomPick() {
            const rows = Array.from(document.querySelectorAll('.game-row')).filter(r => r.style.display !== 'none');
            if (rows.length === 0) return alert('ì¶”ì²œí•  ê²Œì„ì´ ì—†ì–´ìš”!');
            const row = rows[Math.floor(Math.random() * rows.length)];
            const title = row.querySelector('td:nth-child(3)').innerText;
            const fullTitle = row.querySelector('td:nth-child(2)').innerText;
            const link = row.querySelector('td:nth-child(7) a')?.href;
            document.getElementById('modalTitle').innerText = title !== '-' ? title : fullTitle;
            document.getElementById('modalInfo').innerText = "ì´ ê²Œì„ ì–´ë•Œìš”?";
            document.getElementById('modalLinks').innerHTML = link ? `<a href="${link}" target="_blank" class="btn btn-primary">ìƒì  ê°€ê¸°</a>` : '';
            new bootstrap.Modal(document.getElementById('conchModal')).show();
        }
    </script>
</body>
</html>